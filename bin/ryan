#!/usr/bin/env reia

module GoRyan
  def run(args)
    port = 8001
    port = args[1].to_int() if args[0] == '-p' or args[0] == '--port'
    
    if args[0] == '-h' or args[0] == '--help'
      help()
    else
      check_couchdb()
      if load_application()
        dependencies()
        init_ets()
      
        if [a | a in args, a=='--yaws'].size() == 0
          mochi_shim::start_mochi(port)
        else
          yaws_shim::init_yaws(port)
        end
      end
    end
  end

  def dependencies
    'Starting up Ryan...'.puts()
    ryan_dir = [code::lib_dir().to_string(), 'ryan'].join('/')

    required = ['retem.re', 'ryan.re', 'session.re', 'controller.re']
    'Loading '.print()
    required.each do |lib|
      '#{lib} '.print()
      Main.load('#{ryan_dir}/#{lib}')
    end
    ' done.'.puts()
  end

  def init_ets
    ets::new(:sessions, [:named_table, :public])
    ets::new(:templates, [:named_table, :public])
  end

  def check_couchdb
    try
      erlang_couchdb::server_info(('localhost'.to_list(), 5984))
      true
    catch e
      "! CouchDB doesn't seem to be running".puts()
      false
    end
  end

  def load_application
    try
      Main.load('startup.re')
      Startup.initialize()
      true
    catch e
      '! You are either running from incorrect folder, either startup.re is missing'.puts()
      false
    end
  end
  
  def help
    'Usage: ryan [--help|-h] [--port|-p <port_number>] [--yaws|--mochi]'.puts()
  end
end  
  
GoRyan.run(System.args())
